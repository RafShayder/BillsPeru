<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cierre de Venta - Zapatería</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
      :root{
        --brand-1:#16a34a; /* emerald-600 */
        --brand-2:#22c55e; /* emerald-500 */
        --ink:#0f172a;     /* slate-900 */
        --muted:#64748b;   /* slate-500 */
        --card:#ffffff;
      }
      html,body{ height:100%; }
      body{
        font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
        background:
          radial-gradient(1200px 600px at 10% -10%, rgba(34,197,94,.18) 0, rgba(34,197,94,0) 50%),
          radial-gradient(1000px 500px at 110% 10%, rgba(16,185,129,.16) 0, rgba(16,185,129,0) 55%),
          linear-gradient(180deg, #f7f7f7, #f0fdf4);
        color:var(--ink);
      }
      .brand-badge{
        display:inline-flex; align-items:center; gap:.5rem;
        padding:.375rem .75rem; border-radius:999px;
        background:rgba(34,197,94,.1); color:#065f46; font-weight:700; letter-spacing:.2px;
      }
      .brand-badge .dot{
        width:.55rem; height:.55rem; border-radius:50%;
        background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
        box-shadow:0 0 0 4px rgba(16,185,129,.12);
      }
      .hero{ text-align:center; margin-top:2rem; margin-bottom:1rem; }
      .hero h1{
        font-weight:800; letter-spacing:.2px; margin:.5rem 0 0 0;
        background:linear-gradient(135deg,var(--ink) 0%, #065f46 100%);
        -webkit-background-clip:text; background-clip:text; color:transparent;
      }
      .hero p{ color:var(--muted); margin:0; }

      .card.lift{
        border:0; border-radius:1.25rem; overflow:hidden; background:var(--card);
        box-shadow:0 20px 40px rgba(2,6,23,.06), 0 2px 8px rgba(2,6,23,.04);
        transition:transform .2s ease, box-shadow .2s ease;
      }
      .card.lift:hover{ transform:translateY(-2px); box-shadow:0 24px 50px rgba(2,6,23,.08), 0 3px 10px rgba(2,6,23,.05); }

      .card-header.gradient{
        background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
        color:#fff; border:0; padding:1.25rem 1.5rem;
      }
      .card-header .subtitle{ opacity:.85; }

      .form-label{ font-weight:600; }
      .required::after{ content:" *"; color:#ef4444; }

      .input-icon{ position:relative; }
      .input-icon .bi{
        position:absolute; left:.85rem; top:50%; transform:translateY(-50%); opacity:.55;
      }
      .input-icon input, .input-icon textarea{ padding-left:2.25rem; }
      .input-icon select{ padding-left:2.25rem; appearance: none; }

      .helper{ font-size:.85rem; color:var(--muted); }

      .btn-brand{
        background:linear-gradient(135deg,var(--brand-1),var(--brand-2));
        border:0; font-weight:700; letter-spacing:.2px;
        box-shadow:0 10px 20px rgba(16,185,129,.25);
      }
      .btn-brand:hover{ filter:brightness(1.02); }
      .btn-brand:disabled{ opacity:.9; }

      .footer-note{ color:#6b7280; }
      .toast-container{ z-index:1080; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="hero">
        <span class="brand-badge"><span class="dot"></span> Bills Peru</span>
      </div>

      <div class="row justify-content-center">
        <div class="col-12 col-lg-8 col-xl-7">
          <div class="card lift">
            <div class="card-header gradient text-center">
              <div class="h5 mb-0">Registro de ventas</div>
              <div class="subtitle small">Completa los datos con tu venta</div>
            </div>

            <div class="card-body p-4 p-md-5">
              <form id="ventaForm" class="needs-validation" novalidate>
                <div class="row g-4">
                  <div class="col-md-4">
                    <label for="dni" class="form-label required">DNI</label>
                    <div class="input-icon">
                      <i class="bi bi-person-vcard"></i>
                      <input type="text" class="form-control" id="dni" placeholder="87654321" pattern="[0-9]{8}" title="Debe tener 8 dígitos" required/>
                      <div class="invalid-feedback">Ingresa un DNI válido de 8 dígitos.</div>
                    </div>
                  </div>

                  <div class="col-md-8">
                    <label for="nombre" class="form-label required">Nombre del Cliente</label>
                    <div class="input-icon">
                      <i class="bi bi-person-lines-fill"></i>
                      <input type="text" class="form-control" id="nombre" placeholder="Juan Pérez" required/>
                      <div class="invalid-feedback">Ingresa el nombre del cliente.</div>
                    </div>
                  </div>

                  <div class="col-12">
                    <label for="direccion" class="form-label required">Dirección</label>
                    <div class="input-icon">
                      <i class="bi bi-geo-alt"></i>
                      <input type="text" class="form-control" id="direccion" placeholder="Av. Principal 123" required/>
                      <div class="invalid-feedback">Ingresa la dirección.</div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label for="celular" class="form-label required">Celular</label>
                    <div class="input-icon">
                      <i class="bi bi-phone"></i>
                      <input
                        type="tel"
                        class="form-control"
                        id="celular"
                        placeholder="987654321 o +51987654321"
                        pattern="(\+51\s?)?9\d{8}|0\d{1,2}\d{6,7}"
                        title="Comiencen con 9, o con código +51, o con código local"
                        required
                      />
                      <div class="invalid-feedback">Ingresa un número válido (ej. 987654321, +51987654321 o con código local).</div>
                    </div>
                    <div class="helper mt-1">Acepta +51 o código local (01, 044, etc.).</div>
                  </div>

                  <!-- SKU visible -->
                  <div class="col-md-6">
                    <label for="sku" class="form-label required">SKU</label>
                    <div class="input-icon">
                      <i class="bi bi-upc-scan"></i>
                      <input type="text" class="form-control" id="sku" placeholder="escribe el codigo del producto" required/>
                      <div class="invalid-feedback">Ingresa el SKU del producto.</div>
                    </div>
                    <div class="helper mt-1">Ej.: ZAP-CLAS-NEG-42</div>
                  </div>

                  <!-- Currier -->
                  <div class="col-md-6">
                    <label for="currier" class="form-label required">Currier</label>
                    <div class="input-icon">
                      <i class="bi bi-truck"></i>
                      <select class="form-select" id="currier" required>
                        <option value="" selected disabled>Selecciona el currier</option>
                        <option value="Shalom">Shalom</option>
                        <option value="Radio Moto">Radio Moto</option>
                        <option value="Otros">Otros</option>
                      </select>
                      <div class="invalid-feedback">Selecciona una opción.</div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label for="cantidad" class="form-label required">Cantidad</label>
                    <div class="input-icon">
                      <i class="bi bi-123"></i>
                      <input type="number" class="form-control" id="cantidad" min="1" value="1" required/>
                      <div class="invalid-feedback">La cantidad debe ser al menos 1.</div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label for="precio" class="form-label required">Pago Total</label>
                    <div class="input-group">
                      <span class="input-group-text">S/</span>
                      <input type="number" class="form-control" id="precio" placeholder="150.00" min="1" step="0.01" required/>
                    </div>
                    <div class="invalid-feedback">Ingresa el monto total.</div>
                    <div class="helper mt-1">Incluye todos los cargos y descuentos.</div>
                  </div>

                  <div class="col-12">
                    <label for="observacion" class="form-label">Observación</label>
                    <div class="input-icon">
                      <i class="bi bi-chat-left-text"></i>
                      <textarea class="form-control" id="observacion" placeholder="Notas adicionales..." rows="3"></textarea>
                    </div>
                  </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                  <button id="btnEnviar" type="submit" class="btn btn-brand btn-lg">
                    <span class="btn-text"><i class="bi bi-check2-circle me-1"></i> Enviar</span>
                    <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                  </button>
                </div>

                <div class="text-center mt-3">
                  <small class="footer-note">Modo: <span id="modoLabel">test</span> • Los datos se registrarán.</small>
                </div>
              </form>
            </div>
          </div>

          <div class="text-center mt-3">
            <small class="text-muted">© <script>document.write(new Date().getFullYear())</script> Bills Peru</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div id="toastOk" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">✅ Datos enviados correctamente.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
      <div id="toastError" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">❌ Ocurrió un error al enviar los datos.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
      <div id="toastWarn" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">⚠ No se pudo conectar con el servidor.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
  // ====== CONFIG ======
  const modo = "test"; // "produccion" | "test"
  const urls = {
    test: "https://n8n.srv936604.hstgr.cloud/webhook-test/29d2d0ba-2fb4-41fd-92a1-4a1867bb4e65",
    produccion: "https://n8n.srv936604.hstgr.cloud/webhook/29d2d0ba-2fb4-41fd-92a1-4a1867bb4e65",
  };
  const webhookURL = urls[modo];
  document.getElementById("modoLabel").textContent = (modo === "produccion" ? "producción" : "test");

  // ====== CHATWOOT: obtener contexto para metadata ======
  let chatwootMeta = {};
  const isJSON = (s) => { try { JSON.parse(s); return true; } catch { return false; } };

  // Escuchar mensaje con el contexto desde Chatwoot
  window.addEventListener("message", (event) => {
    if (!isJSON(event.data)) return;
    const ev = JSON.parse(event.data);
    if (ev.event === "appContext") {
      const ctx = ev.data || {};
      // Construir metadata segura
      chatwootMeta = {
        account_id: ctx.account?.id ?? null,
        account_name: ctx.account?.name ?? null,
        inbox_id: ctx.inbox?.id ?? null,
        inbox_name: ctx.inbox?.name ?? null,

        conversation_id: ctx.conversation?.id ?? null,
        conversation_status: ctx.conversation?.status ?? null, // open, resolved, snoozed...
        assignee_id: ctx.conversation?.assignee?.id ?? null,
        assignee_name: ctx.conversation?.assignee?.name ?? null,

        current_user_id: ctx.current_user?.id ?? null,
        current_user_name: ctx.current_user?.name ?? null,     // agente que usa el widget
        current_user_email: ctx.current_user?.email ?? null,   // NUEVO: email del remitente

        contact_id: ctx.contact?.id ?? null,
        contact_name: ctx.contact?.name ?? null,
        contact_email: ctx.contact?.email ?? null,
        contact_phone: ctx.contact?.phone_number ?? null,

        labels: ctx.conversation?.labels ?? []
      };

      // ====== NUEVO: Autocompletar campos si están vacíos ======
      const nombreEl = document.getElementById("nombre");
      const celEl    = document.getElementById("celular");

      if (nombreEl && !nombreEl.value && chatwootMeta.contact_name) {
        nombreEl.value = chatwootMeta.contact_name;
      }
      if (celEl && !celEl.value && chatwootMeta.contact_phone) {
        celEl.value = chatwootMeta.contact_phone;
      }
      // ====== FIN NUEVO ======
    }
  });

  // Pedir el contexto al cargar (funciona cuando el HTML está incrustado como Dashboard App)
  window.parent?.postMessage('chatwoot-dashboard-app:fetch-info', '*');

  // ====== UI Helpers ======
  const toast = (id) => new bootstrap.Toast(document.getElementById(id), { delay: 3000 });
  const btnEnviar = document.getElementById("btnEnviar");
  const setLoading = (loading) => {
    btnEnviar.disabled = loading;
    btnEnviar.querySelector(".spinner-border").classList.toggle("d-none", !loading);
    btnEnviar.querySelector(".btn-text").innerHTML = loading
      ? '<i class="bi bi-arrow-repeat me-1"></i> Enviando...'
      : '<i class="bi bi-check2-circle me-1"></i> Enviar';
  };

  // ====== Validación + Envío ======
  (() => {
    const form = document.getElementById("ventaForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      form.classList.add("was-validated");
      if (!form.checkValidity()) return;

      const payload = {
        dni: document.getElementById("dni").value.trim(),
        nombre: document.getElementById("nombre").value.trim(),
        direccion: document.getElementById("direccion").value.trim(),
        celular: document.getElementById("celular").value.trim(),
        sku: document.getElementById("sku").value.trim(),
        currier: document.getElementById("currier").value,
        cantidad: Number(document.getElementById("cantidad").value),
        precio: Number(document.getElementById("precio").value),
        observacion: document.getElementById("observacion").value.trim(),

        // 👉 Metadata de Chatwoot (incluye current_user_email)
        chatwootMeta
      };

      try {
        setLoading(true);
        const response = await fetch(webhookURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          toast("toastOk").show();
          form.reset();
          form.classList.remove("was-validated");
        } else {
          toast("toastError").show();
        }
      } catch (error) {
        toast("toastWarn").show();
      } finally {
        setLoading(false);
      }
    }, false);
  })();
</script>

  </body>
</html>
